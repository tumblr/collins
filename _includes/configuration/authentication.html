<p class="lead">Setting up user authentication and authorization</p>
<h2>Authentication <small><span class="label label-info">Namespace</span> <span class="inlinecode">authentication</span></small></h2>

<p>
Collins supports a variety of authentication backends along with a flexible API endpoint based
permissions system. Some features also have specific permissions.
</p>

<p>
Collins comes bundled with a small in memory authentication mechanism for testing, file based
authentication, and LDAP based authentication. There is not yet support for LDAPS authentication
so if you use LDAP we recommend running a slave on the collins host.
</p>

<table class="table table-condensed table-hover">
  <thead>
    <tr>
      <th>Key</th><th>Type</th><th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="inlinecode">type</td>
      <td>String</td>
      <td>Defaults to default, which is the in-memory database. Other valid values are file or ldap</td>
    </tr>
    <tr>
      <td class="inlinecode">permissionsFile</td>
      <td>String</td>
      <td>Path to the YAML file containing the application permissions. There is a sample permissions file below. Every API endpoint has a name associated with it. You can configure per endpoint permissions as well as some feature permissions.</td>
    </tr>
    <tr>
      <td class="inlinecode">permissionsCacheSpecification</td>
      <td>String</td>
      <td>The guava cache specification to use for the permissions file, as described in <a href="https://google.github.io/guava/releases/17.0/api/docs/com/google/common/cache/CacheBuilderSpec.html">com.google.common.cache.CacheBuilderSpec</a>. Defaults to "expireAfterWrite=30s".</td>
    </tr>
    <tr>
      <td class="inlinecode">adminGroup</td>
      <td>Set[String]</td>
      <td>A list of groups for administrative users. Users that have one of these groups will be in the admin group. Note that being in the adminGroup doesn't always mean you will have access to something, but by default it will. Using the permissionsFile it is possible to configure permissions such that even someone in the admin group can't access a partilar feature or API endpoint.</td>
    </tr>
  </tbody>
</table>

<p>
The permissions example below creates two user groups, admins and tools. User groups are just named groups of users
that are stored in the YAML file. This is useful for people authenticating with flat files or if you want to store
some group information here. The admins user group has two users, alan and bmatheny. The tools user group has three
users. There are two feature permissions specified, one for rate limiting and the other for who can see passwords.
The last permission is for the powerStatus API endpoint and is open to a broader group of users. Every API permission
name is documented in the API documentation.
</p>

<div class="accordion" id="permissions">
  <div class="accordion-group">
    <div class="accordion-heading">
      <a class="accordion-toggle" data-toggle="collapse" data-parent="#permissions" href="#perm-example">Permissions Example</a>
    </div>
    <div id="perm-example" class="accordion-body collapse">
      <div class="accordion-inner">
<pre>
users:
  admins:
    - "alan"
    - "bmatheny"
  tools:
    - "jetpants"
    - "itouch"
    - "phil"
permissions:
  feature.noRateLimit:
    - "u=tools"
  feature.canSeePasswords:
    - "u=admins"
    - "u=tools"
    - "g=infra"
  controllers.AssetManagementApi.powerStatus:
    - "g=infra"
    - "g=ops"
    - "u=admins"
    - "u=tools"
</pre>
      </div> <!-- accordion inner -->
    </div> <!-- accordion-body -->
  </div> <!-- accordion-group -->
</div>

<div class="example reference-config">
<pre>authentication {
  type = default
  permissionsFile = "conf/permissions.yaml"
  permissionsCacheSpecification = "expireAfterWrite=30s"
  adminGroup = [Infra]
}</pre>
</div>

<h3>LDAP Authentication <small><span class="label label-info">Namespace</span> <span class="inlinecode">authentication.ldap</span></small></h3>

<p>
At Tumblr LDAP is the primary authentication mechanism. We have tested that this code works with
at least RFC 2307, IPA, and the OS X admin server.
</p>

<table class="table table-condensed table-hover">
  <thead>
    <tr>
      <th>Key</th><th>Type</th><th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="inlinecode">host</td>
      <td>String</td>
      <td>The LDAP host to authenticate against. This is a required configuration.</td>
    </tr>
    <tr>
        <td class="inlinecode">ssl</td>
        <td>Boolean</td>
        <td>Whether or not to use LDAPS when communicating with the LDAP server.  Defaults to <span class="inlinecode">false</span></td>
    </tr>
    <tr>
      <td class="inlinecode">schema</td>
      <td>Enum</td>
      <td>
        One of rfc2307 or rfc2307bis. This is a required configuration.
      </td>
    </tr>
    <tr>
      <td class="inlinecode">searchbase</td>
      <td>String</td>
      <td>The LDAP search base to use.  This is a required configuration.</td>
    </tr>
    <tr>
      <td class="inlinecode">usersub</td>
      <td>String</td>
      <td>Where to find users in the LDAP schema.  This is a required configuration.</td>
    </tr>
    <tr>
      <td class="inlinecode">groupsub</td>
      <td>String</td>
      <td>Where to find groups in the LDAP schema. This is a required configuration.</td>
    </tr>
    <tr>
        <td class="inlinecode">anonymous</td>
        <td>Boolean</td>
        <td>Whether to use anonymous searches. Defaults to <span class="inlinecode">false</span></td>
    </tr>
    <tr>
        <td class="inlinecode">binddn</td>
        <td>String</td>
        <td>The bind DN to use for ldap searches.  Only used when <span class="inlinecode">anonymous</span> is set to <span class="inlinecode">false</span>. Defaults to <span class="inlinecode">""</span></td>
    </tr>
    <tr>
        <td class="inlinecode">bindpwd</td>
        <td>String</td>
        <td>The bind password to use for ldap searches.  Only used when <span class="inlinecode">anonymous</span> is set to <span class="inlinecode">false</span>. Defaults to <span class="inlinecode">""</span></td>
    </tr>
    <tr>
        <td class="inlinecode">userAttribute</td>
        <td>String</td>
        <td>The LDAP schema attribute used to identify the user name. Defaults to <span class="inlinecode">uid</span></td>
    </tr>
    <tr>
        <td class="inlinecode">userNumberAttribute</td>
        <td>String</td>
        <td>The LDAP schema attribute used to identify the user id number. Defaults to <span class="inlinecode">uidNumber</span></td>
    </tr>
    <tr>
        <td class="inlinecode">groupAttribute</td>
        <td>String</td>
        <td>An LDAP schema attribute to use for retrieving group information.  This is a required configuration</td>
    </tr>
    <tr>
        <td class="inlinecode">groupNameAttribute</td>
        <td>String</td>
        <td>An LDAP schema attribute to use for identifying the group set in <span class="inlinecode">groupAttribute</span>. Defaults to <span class="inlinecode">cn</span></td>
    </tr>
    <tr>
        <td class="inlinecode">cacheSpecification</td>
        <td>String</td>
      <td>The guava cache specification to use for LDAP, as described in <a href="https://google.github.io/guava/releases/17.0/api/docs/com/google/common/cache/CacheBuilderSpec.html">com.google.common.cache.CacheBuilderSpec</a>. Defaults to "expireAfterWrite=30s".</td>
    </tr>
  </tbody>
</table>

<div class="example reference-config">
<pre>authentication {
  type = ldap
  ldap {
    host = "localhost"
    groupAttribute = "uniqueMember"
    searchbase = "dc=example,dc=org"
    usersub = "ou=people"
    groupsub = "ou=groups"
    cacheSpecification = "expireAfterWrite=30s"
  }
}</pre>
</div>

<h3>File Authentication <small><span class="label label-info">Namespace</span> <span class="inlinecode">authentication.file</span></small></h3>

<p>
The file format used is a variation on that used by Apache. You can find a sample script for generating
users and passwords in <code>scripts/gen_passwords.sh</code>.
</p>

<table class="table table-condensed table-hover">
  <thead>
    <tr>
      <th>Key</th><th>Type</th><th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="inlinecode">userfile</td>
      <td>String</td>
      <td>The file to look in for auth information</td>
    </tr>
    <tr>
      <td class="inlinecode">cacheSpecification</td>
      <td>String</td>
      <td>The guava cache specification to use for file-based auth, as described in <a href="https://google.github.io/guava/releases/17.0/api/docs/com/google/common/cache/CacheBuilderSpec.html">com.google.common.cache.CacheBuilderSpec</a>. Defaults to "expireAfterWrite=30s".</td>
    </tr>
  </tbody>
</table>

<div class="example reference-config">
<pre>authentication {
  type = file
  file {
    userfile = "conf/users.conf"
    cacheSpecification = "expireAfterWrite=30s"
  }
}</pre>
</div>

<h3>Mixed Authentication</h3>

<p>
Mixed authentication allows collins to use multiple authentication backends
simultaneously. An example use-case could be a scenario where real users live in
LDAP but system users (for automation etc.) are defined using file
authentication.
</p>
<p>
To use mixed authentication, simply specify a list of authentication backends as
the type, and add configuration (as described above) for each of them within the
authentication block. A simple example can be seen below.
</p>
<p>
The mixed authentication provider will try each of the methods in the order
listed and use the first one that returns a successful match.
</p>

<div class="example reference-config">
<pre>authentication {
  type = "file,ldap"

  file {
    userfile = "conf/users.conf"
  }

  ldap {
    host = "localhost"
    groupAttribute = "uniqueMember"
    searchbase = "dc=example,dc=org"
    usersub = "ou=people"
    groupsub = "ou=groups"
  }
}</pre>

</div>
